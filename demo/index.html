<!DOCTYPE html>
<html lang="en">
<head>
   
<!-- Google tag (gtag.js) -->
  <!-- Content Security Policy (V4 Security) -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.snipcart.com https://app.snipcart.com;
    style-src 'self' 'unsafe-inline' https://cdn.snipcart.com https://app.snipcart.com;
    img-src 'self' data: https://res.cloudinary.com https://app.snipcart.com https://*.snipcart.com;
    connect-src 'self' https://api.github.com https://api.cloudinary.com https://app.snipcart.com https://*.snipcart.com;
    frame-src https://app.snipcart.com https://*.snipcart.com;
    font-src 'self' https://app.snipcart.com https://*.snipcart.com;
  ">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JHE179GXX5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-JHE179GXX5');
</script>
   
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#0f172a">

<title>RapidWoo Product Editor</title>

<!-- Import modular CSS -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/components.css">
<link rel="stylesheet" href="/assets/css/editor.css">

</head>

<body>
<!-- Header -->
<header class="site-header">
  <div class="header-container">
    <a href="/index.html" class="site-logo" aria-label="RapidWoo Home">
      <div class="logo-icon"></div>
      <span>RapidWoo</span>
    </a>

    <nav class="primary-nav">
      <a href="/index.html" class="nav-link">Home</a>
      <a href="/shop.html" class="nav-link">Shop</a>
      <a href="/demo/index.html" class="nav-link">Editor</a>
    </nav>

    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Open menu" aria-expanded="false" aria-controls="mobile-menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </div>
</header>

<!-- Mobile Menu -->
<div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>
<div class="mobile-menu" id="mobile-menu" aria-hidden="true">
  <div class="mobile-menu-header">
    <a href="/index.html" class="site-logo" aria-label="RapidWoo Home">
      <div class="logo-icon"></div>
      <span>RapidWoo</span>
    </a>
    <button class="mobile-menu-close" id="mobile-menu-close" aria-label="Close menu">‚úï</button>
  </div>
  <nav class="mobile-menu-nav">
    <a href="/index.html" class="mobile-nav-link">Home</a>
    <a href="/shop.html" class="mobile-nav-link">Shop</a>
    <a href="/demo/index.html" class="mobile-nav-link">Editor</a>
  </nav>
</div>

<!-- Main Content -->
<div class="fpe-wrap">
  <h1 class="fpe-title">Products</h1>
  
  <div class="fpe-header">
    <div class="fpe-toolbar">
      <!-- Primary Actions - Always Visible -->
      <button id="btn-add" class="button button-primary">‚ûï Add Product</button>
      <button id="btn-github-save" class="button btn-save">üíæ Save</button>
      
      <!-- Settings Button (Opens serverless configuration) -->
      <button id="btn-settings" class="button btn-settings">‚öôÔ∏è Settings</button>
      
      <!-- View Dropdown -->
      <div class="toolbar-dropdown">
        <button class="button dropdown-toggle" data-dropdown="view-menu">
          üëÅÔ∏è View <span class="caret">‚ñº</span>
        </button>
        <div class="dropdown-menu" id="view-menu">
          <button id="btn-view-shop" class="dropdown-item">üõí View Shop</button>
          <button id="btn-view-live-shop" class="dropdown-item">‚öôÔ∏è Shop Settings</button>
          <button id="btn-spreadsheet-modal" class="dropdown-item">üìä Spreadsheet View</button>
        </div>
      </div>
      
      <!-- Data Dropdown -->
      <div class="toolbar-dropdown">
        <button class="button dropdown-toggle" data-dropdown="data-menu">
          üìÅ Data <span class="caret">‚ñº</span>
        </button>
        <div class="dropdown-menu" id="data-menu">
          <button id="btn-load-demo" class="dropdown-item">üîÑ Refresh Saved Products</button>
          <button id="btn-load-dummy" class="dropdown-item">üì¶ Load Demo Products</button>
          <hr class="dropdown-divider">
          <label class="dropdown-item" for="file-import">üì• Import JSON</label>
          <input id="file-import" type="file" accept=".json" style="display:none">
          <button id="btn-download" class="dropdown-item">üì§ Export JSON</button>
        </div>
      </div>
    </div>
  </div>

  <div class="fpe-card fpe-pad">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div class="fpe-meta">Edit inline (click fields), or click ‚úèÔ∏è to open editor panel. Click üëÅÔ∏è to preview.</div>
      <div class="shop-controls" style="margin:0">
        <div class="shop-toggle">
          <input type="checkbox" id="toggle-home-image" checked>
          <label for="toggle-home-image">Images</label>
        </div>
        <div class="shop-toggle">
          <input type="checkbox" id="toggle-home-sku">
          <label for="toggle-home-sku">SKU</label>
        </div>
        <div class="shop-toggle">
          <input type="checkbox" id="toggle-home-price" checked>
          <label for="toggle-home-price">Price</label>
        </div>
        <div class="shop-toggle">
          <input type="checkbox" id="toggle-home-categories" checked>
          <label for="toggle-home-categories">Categories</label>
        </div>
        <div class="shop-toggle">
          <input type="checkbox" id="toggle-home-tags" checked>
          <label for="toggle-home-tags">Tags</label>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  <div class="bulk-actions-bar" id="bulk-bar">
    <div class="bulk-cell checkbox">
      <input type="checkbox" id="bulk-select-all" class="fpe-checkbox" title="Select all">
    </div>
    <div class="bulk-cell actions">
      <select id="bulk-action" class="fpe-select" style="width:auto;min-width:150px">
        <option value="">Bulk actions</option>
        <option value="delete">Move to Trash</option>
        <option value="hide">Hide from Shop</option>
        <option value="unhide">Show in Shop</option>
      </select>
      <button id="apply-bulk" class="button">Apply</button>
    </div>
  </div>

<!-- Products Table -->
<div class="fpe-table-wrap has-bulk-actions" id="table-wrap">
  <table class="fpe-products-table">
<thead>
  <tr>
    <th style="width:40px"><input type="checkbox" id="select-all" class="fpe-checkbox"></th>
    <th style="width:70px" data-col="image">Image</th>
    <th style="width:110px;text-align:center;" data-col="quick-actions" colspan="2">Actions</th>
    <th data-col="name">Name</th>
    <th data-col="sku">SKU</th>
    <th style="width:150px" data-col="stock">Stock</th>
    <th style="width:140px" data-col="price">Price</th>
    <th data-col="categories">Categories</th>
    <th data-col="tags">Tags</th>
    <th style="width:240px" data-col="actions">Options</th>
  </tr>
</thead>
    <tbody id="fpe-tbody"></tbody>
  </table>
</div>

<!-- Side Panel for Editing -->
<div class="fpe-panel" id="fpe-panel">
<div class="fpe-panel-header">
  <span class="header-title">Edit Product</span>
  <div style="display:flex; gap:8px; align-items:center;">
    <button id="fpe-save-top" class="button button-primary">Save Changes</button>
    <button id="fpe-close" class="button">Close</button>
  </div>
</div>
  
  <div class="panel-body">
    <!-- General Section -->
    <div class="fpe-section open">
      <div class="sec-h"><strong>General</strong></div>
      <div class="sec-b">
        <div class="fpe-field">
          <label>Product Name</label>
          <input id="fld-title" type="text">
        </div>
        <div class="fpe-field">
          <label>Slug</label>
          <input id="fld-slug" type="text" placeholder="auto-generated if empty">
        </div>
        <div class="fpe-field">
          <label>SKU</label>
          <input id="fld-sku" type="text">
        </div>
        
        <!-- Image Section -->
        <div class="fpe-field">
          <label>Product Image</label>
          
          <div class="image-preview-container" style="margin-bottom: 12px; position: relative;">
            <img id="image-preview" 
                 src="" 
                 alt="Product preview" 
                 style="display: none; max-width: 100%; height: auto; border-radius: 8px; border: 2px solid #e5e7eb;">
          </div>

          <div class="rw-slot">
            <div class="rw-url-wrap">
              <input id="fld-image" class="rw-url-input" type="text" placeholder="paste image URL">
              <span class="rw-url-optional">Optional</span>
            </div>
            <div class="rw-actions">
              <button id="btn-upload-image" type="button" class="button rw-icon" title="Upload">
                <span>üì§ Upload</span> 
              </button>
              <button id="btn-clear-image" type="button" class="button rw-remove" title="Clear"><span>Remove</span></button>
            </div>
          </div>

          <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
            Upload a new image or paste an external URL. Supports JPG, PNG, WebP (max 10MB)
          </small>
        </div>
        
        <div class="fpe-field">
          <label>Short Description</label>
          <textarea id="fld-short"></textarea>
        </div>
        <div class="fpe-field">
          <label>Description</label>
          <textarea id="fld-desc"></textarea>
        </div>
        <div class="fpe-inline">
          <div class="fpe-field">
            <label>Categories (comma-separated)</label>
            <input id="fld-cats" type="text">
          </div>
          <div class="fpe-field">
            <label>Tags (comma-separated)</label>
            <input id="fld-tags" type="text">
          </div>
        </div>
      </div>
    </div>

    <!-- Price & Variations Section -->
    <div class="fpe-section">
      <div class="sec-h"><strong>Price & Variations</strong></div>
      <div class="sec-b">
        <div class="fpe-inline">
          <div class="fpe-field">
            <label>Regular Price ($)</label>
            <input id="fld-reg" type="number" step="0.01">
          </div>
          <div class="fpe-field">
            <label>Sale Price ($)</label>
            <input id="fld-sale" type="number" step="0.01">
          </div>
        </div>

        <div class="fpe-inline" style="margin-top:10px">
          <div class="fpe-field">
            <label>Product Type</label>
            <select id="fld-type" class="fpe-select">
              <option value="simple">Simple</option>
              <option value="variable">Variable</option>
            </select>
          </div>

          <div class="fpe-field">
            <label>Main Attribute Name</label>
            <input id="fld-attr-name" type="text" placeholder="Size" value="Size">
          </div>

          <div class="fpe-field">
            <label>Preset Options</label>
            <select id="fld-attr-preset" class="fpe-select">
              <option value="S,M,L,XL">Sizes: S‚ÄìXL</option>
              <option value="XS,S,M,L,XL,XXL,3XL">Sizes: XS‚Äì3XL</option>
              <option value="28,30,32,34,36,38">Numbers: 28‚Äì38</option>
              <option value="custom">Custom‚Ä¶</option>
            </select>
          </div>

          <div class="fpe-field">
            <label>Attribute Options (comma-separated)</label>
            <input id="fld-attr-options" type="text" placeholder="S, M, L, XL">
          </div>

          <div class="fpe-field">
            <label>&nbsp;</label>
            <button id="btn-generate-vars" class="button">Generate variations</button>
          </div>

          <div class="fpe-field">
            <label>&nbsp;</label>
            <button id="btn-generate-skus" class="button">Generate SKUs</button>
          </div>
        </div>

        <div class="fpe-field" id="var-wrap" style="margin-top:10px; display:none;">
          <label>Variations</label>
          <div style="overflow:auto;">
            <table id="var-table" class="table" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e5e7eb;">Option</th>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e5e7eb;">SKU</th>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e5e7eb;">Regular ($)</th>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e5e7eb;">Sale ($)</th>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e5e7eb;">Stock</th>
                  <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e5e7eb;">Remove</th>
                </tr>
              </thead>
              <tbody id="var-tbody"></tbody>
            </table>
          </div>
          <small class="muted">Tip: click "Generate variations" after editing options. You can tweak each row below.</small>
        </div>
      </div>
    </div>

    <!-- Inventory Section -->
    <div class="fpe-section">
      <div class="sec-h"><strong>Inventory</strong></div>
      <div class="sec-b">
        <div class="fpe-inline">
          <div class="fpe-field">
            <label>Stock Status</label>
            <select id="fld-stock-status" class="fpe-select">
              <option value="instock">In Stock</option>
              <option value="outofstock">Out of Stock</option>
              <option value="onbackorder">On Backorder</option>
            </select>
          </div>
          <div class="fpe-field">
            <label>Manage Stock?</label>
            <select id="fld-manage" class="fpe-select">
              <option value="true">Yes</option>
              <option value="false" selected>No</option>
            </select>
          </div>
          <div class="fpe-field">
            <label>Stock Quantity</label>
            <input id="fld-stock-qty" type="number">
          </div>
        </div>
        <div class="fpe-inline">
          <div class="fpe-field">
            <label>Featured?</label>
            <select id="fld-featured" class="fpe-select">
              <option value="true">Yes</option>
              <option value="false" selected>No</option>
            </select>
          </div>
          <div class="fpe-field">
            <label>Sold Individually?</label>
            <select id="fld-sold" class="fpe-select">
              <option value="true">Yes</option>
              <option value="false" selected>No</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Shipping Section -->
    <div class="fpe-section">
      <div class="sec-h"><strong>Shipping</strong></div>
      <div class="sec-b">
        <div class="fpe-inline">
          <div class="fpe-field">
            <label>Weight (lbs)</label>
            <input id="fld-weight" type="text">
          </div>
          <div class="fpe-field">
            <label>Shipping Class</label>
            <input id="fld-ship-class" type="text">
          </div>
        </div>
        <div class="fpe-inline">
          <div class="fpe-field">
            <label>Length (in)</label>
            <input id="fld-l" type="text">
          </div>
          <div class="fpe-field">
            <label>Width (in)</label>
            <input id="fld-w" type="text">
          </div>
          <div class="fpe-field">
            <label>Height (in)</label>
            <input id="fld-h" type="text">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel-footer">
    <button id="fpe-cancel" class="button">Cancel</button>
    <button id="fpe-apply" class="button button-primary">Save Changes</button>
  </div>
</div>

<!-- Shop Preview Modal -->
<div class="shop-modal" id="shop-modal">
  <div class="shop-modal-content">
    <div class="shop-header">
      <h2 style="margin:0;font-size:24px">Shop Preview</h2>

      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
        <div class="shop-controls">
          <div class="shop-toggle">
            <input type="checkbox" id="toggle-title" checked />
            <label for="toggle-title">Show Titles</label>
          </div>
          <div class="shop-toggle">
            <input type="checkbox" id="toggle-price" checked />
            <label for="toggle-price">Show Prices</label>
          </div>
          <div class="shop-toggle">
            <input type="checkbox" id="toggle-description" checked />
            <label for="toggle-description">Show Description</label>
          </div>
          <div class="shop-toggle">
            <input type="checkbox" id="toggle-stock" checked />
            <label for="toggle-stock">Show Stock</label>
          </div>
          <div class="shop-toggle">
            <input type="checkbox" id="toggle-add" checked />
            <label for="toggle-add">Show Add</label>
          </div>
        </div>
        <button class="modal-close" id="shop-close">‚úï</button>
      </div>
    </div>
    <div class="shop-products-grid" id="shop-products-grid"></div>
  </div>
</div>

<!-- Product IFRAME Modal -->
<div id="product-iframe-modal" class="product-modal" hidden>
  <div class="modal-content" style="width:min(1100px,96vw);">
    <div class="modal-header">
      <h2 style="margin:0;font-size:18px">Product Preview</h2>
      <button class="modal-close" id="pim-close">‚úï</button>
    </div>
    <div class="modal-body" style="padding:0;">
      <iframe id="pim-frame" title="Product preview"
              loading="lazy"
              style="display:block;width:100%;height:78vh;border:0;border-radius:0 0 8px 8px;"></iframe>
    </div>
  </div>
</div>

<!-- Spreadsheet Modal -->
<div class="spreadsheet-modal" id="spreadsheetModal">
  <button class="spreadsheet-close-btn-overlay" id="closeSpreadsheet"></button>
  <iframe id="spreadsheetFrame" src=""></iframe>
</div>

<!-- Hidden file input for image upload -->
<input type="file" id="image-file-input" accept="image/jpeg,image/png,image/webp,image/gif" style="display: none;">

<!-- Compat stubs -->
<div id="product-modal" class="product-modal" hidden style="display:none">
  <button id="modal-close" type="button" aria-hidden="true" style="display:none"></button>
</div>

<div id="quickview-modal" class="modal" hidden style="display:none">
  <button id="quickview-close" type="button" aria-hidden="true" style="display:none"></button>
</div>

</div>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="container">
    <div class="footer-grid">
      <div class="footer-brand">
        <a href="/index.html" class="site-logo" aria-label="RapidWoo Home">
          <div class="logo-icon"></div>
          <span>RapidWoo</span>
        </a>
        <p class="footer-tagline">100% Serverless e-commerce platform with browser-based editing.</p>
      </div>
      <div class="foot-links">
        <a href="/index.html">Home</a>
        <a href="/shop.html">Shop</a>
        <a href="/demo/index.html">Editor</a>
      </div>
    </div>
  </div>
</footer>

<!-- Import JavaScript modules (Serverless versions) -->
<script src="/assets/js/config.js"></script>
<script src="/assets/js/storage.js"></script>
<script src="/assets/js/imageHandler.js"></script>
<script src="/assets/js/utils.js"></script>
<script src="/assets/js/cart.js"></script>
<script src="/assets/js/settings.js"></script>
<script src="/demo/editor.js"></script>

<script>
/* RapidWoo ‚Äî Settings Button Handler */
(function() {
  const settingsBtn = document.getElementById('btn-settings');
  if (!settingsBtn) return;
  
  settingsBtn.addEventListener('click', function() {
    if (window.RapidWoo && window.RapidWoo.Settings) {
      window.RapidWoo.Settings.open();
    } else {
      console.error('Settings module not loaded');
      alert('Settings module not available. Please check that settings.js is loaded.');
    }
  });
})();
</script>

<script>
/* RapidWoo ‚Äî open the side panel when ?open=<slug|id> is present */
(function () {
  const MAX_WAIT_MS = 6000;
  const RETRY_EVERY = 120;

  function getKey() {
    try { return new URL(location.href).searchParams.get('open'); }
    catch { return null; }
  }

  function findIndex(products, key) {
    if (!key) return -1;
    const k = String(key).trim();
    let i = products.findIndex(p => String(p.slug) === k);
    if (i < 0) i = products.findIndex(p => String(p.id) === k);
    return i;
  }

  let started = false;
  async function attemptOpen() {
    if (started) return;
    const key = getKey();
    if (!key) return;

    const Storage   = window.RapidWoo && window.RapidWoo.Storage;
    const openPanel = window.openPanel;

    if (!Storage?.getProducts || typeof openPanel !== 'function') {
      return;
    }

    started = true;
    try {
      const data = await Storage.getProducts();
      const products = Array.isArray(data?.products) ? data.products : [];
      const idx = findIndex(products, key);

      if (idx >= 0) {
        setTimeout(() => openPanel(idx), 0);
      } else {
        console.warn('Deep link key not found:', key);
      }
    } catch (e) {
      console.error('Deep link failed:', e);
    }
  }

  const t0 = Date.now();
  const timer = setInterval(() => {
    attemptOpen();
    if (Date.now() - t0 > MAX_WAIT_MS || started) clearInterval(timer);
  }, RETRY_EVERY);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attemptOpen, { once: true });
  } else {
    setTimeout(attemptOpen, 0);
  }
  window.addEventListener('rapidwoo:products:updated', attemptOpen, { once: true });
})();
</script>

<script>
/* RapidWoo ‚Äî Unified Preview Handler */
(function(){
  const modal = document.getElementById('product-iframe-modal');
  const frame = document.getElementById('pim-frame');
  const closeBtn = document.getElementById('pim-close');

  if (!modal || !frame) {
    console.error('Preview modal elements not found');
    return;
  }

  function openModal(product){
    if (!product) return;
    console.log('Opening preview for:', product.title || product.id);
    
    const key = encodeURIComponent(product.slug || product.id || '');
    frame.src = `/product.html?product=${key}&embedded=1`;
    
    modal.hidden = false;
    modal.classList.add('open');
    modal.style.display = 'block';
    document.body.classList.add('modal-open');
  }

  function closeModal(){
    modal.classList.remove('open');
    modal.style.display = 'none';
    modal.hidden = true;
    frame.src = 'about:blank';
    document.body.classList.remove('modal-open');
  }

  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
  document.addEventListener('keydown', e => { 
    if (e.key === 'Escape' && modal.classList.contains('open')) closeModal(); 
  });

  async function getProducts(){
    if (window.App?.products?.length) return window.App.products;
    try {
      const data = await window.RapidWoo?.Storage?.getProducts();
      return data?.products || [];
    } catch(e){ 
      console.error('Failed to load products:', e);
      return []; 
    }
  }

  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button');
    if (!btn) return;

    if (btn.closest('.toolbar-dropdown') || btn.classList.contains('dropdown-toggle')) return;

    const row = btn.closest('tr');
    if (!row) return;

    const isEyeButton = 
      btn.textContent.includes('üëÅ') || 
      btn.classList.contains('fpe-icon-preview') ||
      (btn.title && btn.title.toLowerCase().includes('preview')) ||
      (btn.getAttribute('aria-label') || '').toLowerCase().includes('preview');

    if (!isEyeButton) return;

    ev.preventDefault();
    ev.stopPropagation();
    ev.stopImmediatePropagation();

    console.log('Preview button clicked');

    const products = await getProducts();
    let product = null;

    const idx = Number(row.dataset.index);
    if (Number.isFinite(idx) && products[idx]) {
      product = products[idx];
    } else {
      const tbody = row.parentElement;
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const rowIndex = rows.indexOf(row);
      if (rowIndex >= 0 && products[rowIndex]) {
        product = products[rowIndex];
      }
    }

    if (product) {
      openModal(product);
    } else {
      console.warn('Product not found for row:', row);
    }
  }, true);

  window.__testPreview = async (index = 0) => {
    const products = await getProducts();
    if (products[index]) openModal(products[index]);
  };
})();
</script>

<script>
// Spreadsheet Modal Handler
const spreadsheetModal = document.getElementById('spreadsheetModal');
const spreadsheetFrame = document.getElementById('spreadsheetFrame');
const btnOpenSpreadsheet = document.getElementById('btn-spreadsheet-modal');
const btnCloseSpreadsheet = document.getElementById('closeSpreadsheet');

if (btnOpenSpreadsheet) {
  btnOpenSpreadsheet.addEventListener('click', () => {
    const App = window.App;
    if (App && App.products) {
      try {
        const data = { products: App.products };
        localStorage.setItem('rapidwoo_products', JSON.stringify(data));
      } catch (e) {
        console.error('Could not save:', e);
      }
    }
    
    spreadsheetFrame.src = '/demo/spreadsheet.html';
    spreadsheetModal.classList.add('show');
    document.body.style.overflow = 'hidden';
  });
}

if (btnCloseSpreadsheet) {
  btnCloseSpreadsheet.addEventListener('click', () => {
    spreadsheetModal.classList.remove('show');
    spreadsheetFrame.src = '';
    document.body.style.overflow = '';
    
    if (window.App && typeof window.App.products !== 'undefined') {
      try {
        const saved = localStorage.getItem('rapidwoo_products');
        if (saved) {
          const data = JSON.parse(saved);
          window.App.products = data.products || [];
          if (typeof renderTable === 'function') {
            renderTable();
          }
        }
      } catch (e) {
        console.error('Could not reload:', e);
      }
    }
  });
}
</script>

<script>
// GitHub Save Button Handler - uses saveToGitHubManual() from editor.js
(function() {
  const btn = document.getElementById('btn-github-save');
  if (!btn) return;
  
  btn.addEventListener('click', async function() {
    const originalText = btn.textContent;
    const Storage = window.RapidWoo?.Storage;
    const Utils = window.RapidWoo?.Utils;
    
    // Check if GitHub is configured
    const config = Storage?.getGitHubConfig?.();
    if (!config?.token || !config?.repo) {
      Utils?.showToast?.('GitHub not configured. Click ‚öôÔ∏è Settings to set up.', 'warning') ||
        alert('GitHub not configured. Click Settings to set up your GitHub token and repository.');
      return;
    }
    
    // Use the saveToGitHubManual function from editor.js (has lock to prevent concurrent saves)
    if (typeof window.saveToGitHubManual === 'function') {
      btn.disabled = true;
      btn.textContent = 'üîÑ Saving...';
      
      const result = await window.saveToGitHubManual();
      
      if (result.success) {
        btn.textContent = '‚úÖ Saved!';
      } else {
        btn.textContent = '‚ùå Error';
      }
      
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = originalText;
      }, 2000);
    } else {
      // Fallback if editor.js hasn't loaded yet
      Utils?.showToast?.('Editor not ready, please try again', 'warning');
    }
  });
})();
</script>

<script>
// Toolbar Dropdown Handler
(function() {
  const backdrop = document.createElement('div');
  backdrop.className = 'dropdown-backdrop';
  document.body.appendChild(backdrop);

  function toggleDropdown(dropdown, forceClose = false) {
    const isOpen = dropdown.classList.contains('open');
    
    document.querySelectorAll('.toolbar-dropdown.open').forEach(d => {
      d.classList.remove('open');
    });
    backdrop.classList.remove('show');
    
    if (!isOpen && !forceClose) {
      dropdown.classList.add('open');
      if (window.innerWidth <= 768) {
        backdrop.classList.add('show');
      }
    }
  }

  document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
    toggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const dropdown = toggle.closest('.toolbar-dropdown');
      toggleDropdown(dropdown);
    });
  });

  document.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', () => {
      document.querySelectorAll('.toolbar-dropdown.open').forEach(d => {
        d.classList.remove('open');
      });
      backdrop.classList.remove('show');
    });
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.toolbar-dropdown')) {
      document.querySelectorAll('.toolbar-dropdown.open').forEach(d => {
        d.classList.remove('open');
      });
      backdrop.classList.remove('show');
    }
  });

  backdrop.addEventListener('click', () => {
    document.querySelectorAll('.toolbar-dropdown.open').forEach(d => {
      d.classList.remove('open');
    });
    backdrop.classList.remove('show');
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.toolbar-dropdown.open').forEach(d => {
        d.classList.remove('open');
      });
      backdrop.classList.remove('show');
    }
  });
})();
</script>

</body>
</html>
